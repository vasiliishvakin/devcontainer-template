{
	auto_https off
	servers {
		metrics
		timeouts {
			read_body 5m
			read_header 5m
			write 5m
			idle 5m
		}
	}
	log {
		output stdout
		format console
		level info
	}
}

:80 {
	log {
		output stdout
		format console
		level info
	}

    file_server

	root * /workspace/app/public

    @denied {
        path /.*
    }
	respond @denied "Access denied" 403

	@static {
		file
		path *.ico *.css *.js *.gif *.webp *.avif *.jpg *.jpeg *.png *.svg *.woff *.woff2
	}
	@html {
		file
		path *.html
	}
	header @static Cache-Control max-age=5184000,must-revalidate

	header @html Cache-Control max-age=300,must-revalidate

	encode {
		gzip
		zstd

		match {
			status 200
		}
	}

	metrics /caddy-metrics

	php_fastcgi /php-status php:9000 {
		env SCRIPT_NAME /status
	}

    php_fastcgi /php-ping php:9000 {
		env SCRIPT_NAME /ping
	}

    @phpPathPrefix path /php*
    php_fastcgi @phpPathPrefix {
        root /workspace/app/php/public
        dial_timeout 5m
        read_timeout 5m
        write_timeout 5m
        capture_stderr info
        health_uri /ping
    }

    @notStatic not file

    @pythonPathPrefix path /python*
    reverse_proxy @pythonPathPrefix @notStatic python:8000

    @nodePathPrefix path /node*
    reverse_proxy @nodePathPrefix @notStatic node:7000
}
